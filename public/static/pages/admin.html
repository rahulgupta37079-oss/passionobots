<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - PassionBots</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
    <link href="/static/css/styles.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;600;700;800;900&family=Rajdhani:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#FFD300',
                        dark: '#0a0a0a',
                        'dark-secondary': '#1a1a1a'
                    },
                    fontFamily: {
                        'orbitron': ['Orbitron', 'sans-serif'],
                        'rajdhani': ['Rajdhani', 'sans-serif']
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-dark text-white font-rajdhani">
    <!-- Navigation -->
    <nav class="fixed w-full bg-dark/95 backdrop-blur-sm border-b border-gray-800 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-20">
                <div class="flex items-center gap-3">
                    <i class="fas fa-robot text-primary text-3xl"></i>
                    <span class="font-orbitron text-2xl font-bold">Passion<span class="text-primary">Bots</span> <span class="text-sm text-gray-400">Admin</span></span>
                </div>
                <div class="flex items-center gap-4">
                    <a href="/" class="text-gray-400 hover:text-primary transition-colors">
                        <i class="fas fa-home mr-2"></i>Back to Website
                    </a>
                </div>
            </div>
        </div>
    </nav>

    <!-- Dashboard Content -->
    <div class="pt-24 pb-16 min-h-screen">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <h1 class="text-4xl font-orbitron font-bold mb-8">
                <i class="fas fa-chart-line text-primary mr-3"></i>Admin Dashboard
            </h1>

            <!-- Stats Cards -->
            <div id="stats-cards" class="grid md:grid-cols-4 gap-6 mb-12">
                <div class="bg-dark-secondary p-6 rounded-xl border border-gray-800">
                    <div class="flex items-center justify-between mb-2">
                        <h3 class="text-gray-400 text-sm">Total Contacts</h3>
                        <i class="fas fa-envelope text-primary text-xl"></i>
                    </div>
                    <div class="text-3xl font-bold" id="stat-contacts">0</div>
                </div>
                <div class="bg-dark-secondary p-6 rounded-xl border border-gray-800">
                    <div class="flex items-center justify-between mb-2">
                        <h3 class="text-gray-400 text-sm">Total Enrollments</h3>
                        <i class="fas fa-graduation-cap text-primary text-xl"></i>
                    </div>
                    <div class="text-3xl font-bold" id="stat-enrollments">0</div>
                </div>
                <div class="bg-dark-secondary p-6 rounded-xl border border-gray-800">
                    <div class="flex items-center justify-between mb-2">
                        <h3 class="text-gray-400 text-sm">Total Inquiries</h3>
                        <i class="fas fa-question-circle text-primary text-xl"></i>
                    </div>
                    <div class="text-3xl font-bold" id="stat-inquiries">0</div>
                </div>
                <div class="bg-dark-secondary p-6 rounded-xl border border-gray-800">
                    <div class="flex items-center justify-between mb-2">
                        <h3 class="text-gray-400 text-sm">Total Leads</h3>
                        <i class="fas fa-users text-primary text-xl"></i>
                    </div>
                    <div class="text-3xl font-bold" id="stat-total">0</div>
                </div>
            </div>

            <!-- Tabs -->
            <div class="flex gap-4 mb-6 border-b border-gray-800">
                <button class="tab-button active px-6 py-3 font-semibold border-b-2 border-primary text-primary" data-tab="contacts">
                    <i class="fas fa-envelope mr-2"></i>Contact Forms
                </button>
                <button class="tab-button px-6 py-3 font-semibold border-b-2 border-transparent text-gray-400 hover:text-primary" data-tab="enrollments">
                    <i class="fas fa-graduation-cap mr-2"></i>Enrollments
                </button>
                <button class="tab-button px-6 py-3 font-semibold border-b-2 border-transparent text-gray-400 hover:text-primary" data-tab="recent">
                    <i class="fas fa-clock mr-2"></i>Recent Activity
                </button>
            </div>

            <!-- Contacts Tab -->
            <div id="tab-contacts" class="tab-content">
                <div class="bg-dark-secondary rounded-xl border border-gray-800 overflow-hidden">
                    <div class="p-6 border-b border-gray-800">
                        <h2 class="text-xl font-bold">Contact Form Submissions</h2>
                        <p class="text-gray-400 mt-1">People who reached out via contact form</p>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead class="bg-dark border-b border-gray-800">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase">Name</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase">Email</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase">Phone</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase">Subject</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase">Message</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase">Status</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase">Date</th>
                                </tr>
                            </thead>
                            <tbody id="contacts-table-body" class="divide-y divide-gray-800">
                                <tr>
                                    <td colspan="7" class="px-6 py-8 text-center text-gray-400">
                                        <i class="fas fa-spinner fa-spin text-2xl mb-2"></i>
                                        <div>Loading contacts...</div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Enrollments Tab -->
            <div id="tab-enrollments" class="tab-content hidden">
                <div class="bg-dark-secondary rounded-xl border border-gray-800 overflow-hidden">
                    <div class="p-6 border-b border-gray-800">
                        <h2 class="text-xl font-bold">Course Enrollments</h2>
                        <p class="text-gray-400 mt-1">Students who enrolled in courses</p>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead class="bg-dark border-b border-gray-800">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase">Name</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase">Email</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase">Phone</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase">Course</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase">College</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase">Status</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase">Payment</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase">Date</th>
                                </tr>
                            </thead>
                            <tbody id="enrollments-table-body" class="divide-y divide-gray-800">
                                <tr>
                                    <td colspan="8" class="px-6 py-8 text-center text-gray-400">
                                        <i class="fas fa-spinner fa-spin text-2xl mb-2"></i>
                                        <div>Loading enrollments...</div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Recent Activity Tab -->
            <div id="tab-recent" class="tab-content hidden">
                <div class="grid md:grid-cols-2 gap-6">
                    <div class="bg-dark-secondary rounded-xl border border-gray-800 p-6">
                        <h3 class="text-xl font-bold mb-4">
                            <i class="fas fa-envelope text-primary mr-2"></i>Recent Contacts
                        </h3>
                        <div id="recent-contacts-list" class="space-y-3">
                            <div class="text-center text-gray-400 py-4">Loading...</div>
                        </div>
                    </div>
                    <div class="bg-dark-secondary rounded-xl border border-gray-800 p-6">
                        <h3 class="text-xl font-bold mb-4">
                            <i class="fas fa-graduation-cap text-primary mr-2"></i>Recent Enrollments
                        </h3>
                        <div id="recent-enrollments-list" class="space-y-3">
                            <div class="text-center text-gray-400 py-4">Loading...</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/axios@1.6.0/dist/axios.min.js"></script>
    <script>
        // Tab switching
        document.querySelectorAll('.tab-button').forEach(button => {
            button.addEventListener('click', () => {
                const tab = button.dataset.tab;
                
                // Update button states
                document.querySelectorAll('.tab-button').forEach(b => {
                    b.classList.remove('active', 'border-primary', 'text-primary');
                    b.classList.add('border-transparent', 'text-gray-400');
                });
                button.classList.add('active', 'border-primary', 'text-primary');
                button.classList.remove('border-transparent', 'text-gray-400');
                
                // Show/hide content
                document.querySelectorAll('.tab-content').forEach(content => {
                    content.classList.add('hidden');
                });
                document.getElementById(`tab-${tab}`).classList.remove('hidden');
            });
        });

        // Format date
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('en-US', { 
                year: 'numeric', 
                month: 'short', 
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        // Load dashboard data
        async function loadDashboard() {
            try {
                // Load stats
                const statsRes = await axios.get('/api/admin/stats');
                if (statsRes.data.success) {
                    const { stats } = statsRes.data;
                    document.getElementById('stat-contacts').textContent = stats.total_contacts;
                    document.getElementById('stat-enrollments').textContent = stats.total_enrollments;
                    document.getElementById('stat-inquiries').textContent = stats.total_inquiries;
                    document.getElementById('stat-total').textContent = 
                        stats.total_contacts + stats.total_enrollments + stats.total_inquiries;
                    
                    // Load recent activities
                    loadRecentActivities(stats.recent_contacts, stats.recent_enrollments);
                }

                // Load contacts
                const contactsRes = await axios.get('/api/admin/contacts');
                if (contactsRes.data.success) {
                    loadContactsTable(contactsRes.data.contacts);
                }

                // Load enrollments
                const enrollmentsRes = await axios.get('/api/admin/enrollments');
                if (enrollmentsRes.data.success) {
                    loadEnrollmentsTable(enrollmentsRes.data.enrollments);
                }
            } catch (error) {
                console.error('Error loading dashboard:', error);
                if (error.response?.status === 500) {
                    showDatabaseNotConfigured();
                }
            }
        }

        function showDatabaseNotConfigured() {
            const message = `
                <div class="text-center text-yellow-400 py-8">
                    <i class="fas fa-exclamation-triangle text-4xl mb-4"></i>
                    <div class="text-xl font-bold mb-2">Database Not Configured</div>
                    <div class="text-gray-400">
                        The database needs to be set up in production. <br>
                        Run: <code class="bg-dark px-2 py-1 rounded">npx wrangler d1 create passionbots-production</code>
                    </div>
                </div>
            `;
            document.getElementById('contacts-table-body').innerHTML = message;
            document.getElementById('enrollments-table-body').innerHTML = message;
        }

        function loadContactsTable(contacts) {
            const tbody = document.getElementById('contacts-table-body');
            if (!contacts || contacts.length === 0) {
                tbody.innerHTML = `
                    <tr><td colspan="7" class="px-6 py-8 text-center text-gray-400">
                        No contacts yet. People who submit the contact form will appear here.
                    </td></tr>
                `;
                return;
            }

            tbody.innerHTML = contacts.map(contact => `
                <tr class="hover:bg-dark transition-colors">
                    <td class="px-6 py-4 whitespace-nowrap">${contact.name}</td>
                    <td class="px-6 py-4">
                        <a href="mailto:${contact.email}" class="text-primary hover:underline">${contact.email}</a>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        ${contact.phone ? `<a href="tel:${contact.phone}" class="text-primary hover:underline">${contact.phone}</a>` : '-'}
                    </td>
                    <td class="px-6 py-4">${contact.subject || '-'}</td>
                    <td class="px-6 py-4 max-w-xs truncate" title="${contact.message}">${contact.message}</td>
                    <td class="px-6 py-4">
                        <span class="px-2 py-1 rounded-full text-xs ${contact.status === 'new' ? 'bg-green-500/20 text-green-400' : 'bg-gray-500/20 text-gray-400'}">
                            ${contact.status}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-400">${formatDate(contact.created_at)}</td>
                </tr>
            `).join('');
        }

        function loadEnrollmentsTable(enrollments) {
            const tbody = document.getElementById('enrollments-table-body');
            if (!enrollments || enrollments.length === 0) {
                tbody.innerHTML = `
                    <tr><td colspan="8" class="px-6 py-8 text-center text-gray-400">
                        No enrollments yet. Students who enroll will appear here.
                    </td></tr>
                `;
                return;
            }

            tbody.innerHTML = enrollments.map(enrollment => `
                <tr class="hover:bg-dark transition-colors">
                    <td class="px-6 py-4 whitespace-nowrap">${enrollment.name}</td>
                    <td class="px-6 py-4">
                        <a href="mailto:${enrollment.email}" class="text-primary hover:underline">${enrollment.email}</a>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <a href="tel:${enrollment.phone}" class="text-primary hover:underline">${enrollment.phone}</a>
                    </td>
                    <td class="px-6 py-4">${enrollment.course_name}</td>
                    <td class="px-6 py-4">${enrollment.college || '-'}</td>
                    <td class="px-6 py-4">
                        <span class="px-2 py-1 rounded-full text-xs ${enrollment.status === 'pending' ? 'bg-yellow-500/20 text-yellow-400' : 'bg-green-500/20 text-green-400'}">
                            ${enrollment.status}
                        </span>
                    </td>
                    <td class="px-6 py-4">
                        <span class="px-2 py-1 rounded-full text-xs ${enrollment.payment_status === 'paid' ? 'bg-green-500/20 text-green-400' : 'bg-red-500/20 text-red-400'}">
                            ${enrollment.payment_status}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-400">${formatDate(enrollment.created_at)}</td>
                </tr>
            `).join('');
        }

        function loadRecentActivities(contacts, enrollments) {
            const contactsList = document.getElementById('recent-contacts-list');
            const enrollmentsList = document.getElementById('recent-enrollments-list');

            if (!contacts || contacts.length === 0) {
                contactsList.innerHTML = '<div class="text-center text-gray-400 py-4">No recent contacts</div>';
            } else {
                contactsList.innerHTML = contacts.map(contact => `
                    <div class="p-3 bg-dark rounded-lg border border-gray-800">
                        <div class="flex justify-between items-start mb-1">
                            <div class="font-semibold">${contact.name}</div>
                            <div class="text-xs text-gray-400">${formatDate(contact.created_at)}</div>
                        </div>
                        <div class="text-sm text-primary">${contact.email}</div>
                    </div>
                `).join('');
            }

            if (!enrollments || enrollments.length === 0) {
                enrollmentsList.innerHTML = '<div class="text-center text-gray-400 py-4">No recent enrollments</div>';
            } else {
                enrollmentsList.innerHTML = enrollments.map(enrollment => `
                    <div class="p-3 bg-dark rounded-lg border border-gray-800">
                        <div class="flex justify-between items-start mb-1">
                            <div class="font-semibold">${enrollment.name}</div>
                            <div class="text-xs text-gray-400">${formatDate(enrollment.created_at)}</div>
                        </div>
                        <div class="text-sm text-primary">${enrollment.email}</div>
                        <div class="text-xs text-gray-400 mt-1">${enrollment.course_name}</div>
                    </div>
                `).join('');
            }
        }

        // Load dashboard on page load
        document.addEventListener('DOMContentLoaded', loadDashboard);

        // Refresh every 30 seconds
        setInterval(loadDashboard, 30000);
    </script>
</body>
</html>
